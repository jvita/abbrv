{% extends "index.html" %}

{% block title %}
<title>abbrv: rules</title>
{% endblock %}

{% block content %}
<div class="main-content"></div>
    <!-- Add New Rule -->
    <h3>Rules</h3>
    <div>Rules can be used to modify text prior to translation into shorthand glyphs. They are applied using find-and-replace operations with <a href="https://regexone.com/" target="_blank">regular expressions</a>. If you don't want to learn how to write regular expressions (which can be a bit of a pain), try asking your friendly neighborhood LLM to write them for you! The site <a href="https://regex101.com/">regex101</a> can be useful for making sure that your regex is working properly.</div>
    <hr>
    <form id="addRuleForm" class="d-flex flex-row align-items-end">
        <div class="flex-grow-1 me-2">
            <label for="ruleName" class="form-label">
                Name
                <i class="bi bi-question-circle ms-2" style="font-size: 0.8rem;" data-bs-toggle="tooltip" title="A brief, easily understood description of the rule."></i>
            </label>
            <input type="text" class="form-control" id="ruleName" placeholder="Enter name of rule" required>
        </div>
        <div class="flex-grow-1 me-2">
            <label for="regexInput" class="form-label">
                Pattern
                <i class="bi bi-question-circle ms-2" style="font-size: 0.8rem;" data-bs-toggle="tooltip" title="The regular expression used for pattern matching."></i>
            </label>
            <input type="text" class="form-control" id="regexInput" placeholder="Enter regex pattern to be matched" required>
        </div>
        <div class="flex-grow-1 me-2">
            <label for="replacementText" class="form-label">
                Replacement
                <i class="bi bi-question-circle ms-2" style="font-size: 0.8rem;" data-bs-toggle="tooltip" title="The regular expression for replacing any matched patterns."></i>
            </label>
            <input type="text" class="form-control" id="replacementText" placeholder="Enter replacement text">
        </div>
        <div>
            <button type="submit" class="btn btn-primary" style="margin-bottom:2px">Add</button>
        </div>
    </form>

    <div class="mt-4 d-flex justify-content-around">
        Note: the arrow buttons can be used to re-order the list. Rules higher in the list will be applied first.
    </div>

    <!-- Rule List (placed at the bottom) -->
    <div class="mt-4">
        <ul id="rulesList" class="list-group">
            <!-- Rules will be dynamically added here -->
        </ul>
    </div>
</div>
{% endblock %}
{% block scripts %}
<script>
let rules = selectedSystem ? systems[selectedSystem]['rules'] : []

// Function to fetch and render rules
function renderRules() {
    const rulesList = document.getElementById('rulesList');
    rulesList.innerHTML = ''; // Clear the existing list

    // Render each rule
    rules.forEach((rule, index) => {
        const ruleItem = document.createElement('li');
        ruleItem.className = 'list-group-item d-flex justify-content-between align-items-center';

        // Create a div for the rule content (left side)
        const ruleContent = document.createElement('div');
        ruleContent.innerHTML = `
            <strong>Name:</strong> ${rule.name} <br>
        `;

        // Create a span for the regex, ensuring it's safe
        const regexSpan = document.createElement('span');
        regexSpan.innerHTML = `<strong>Pattern:</strong> `;
        const regexContent = document.createElement('span');
        regexContent.textContent = rule.regex; // Ensure raw text for regex

        // Append the regex content to the regex span
        regexSpan.appendChild(regexContent);

        // Append the regex span to the ruleContent div
        ruleContent.appendChild(regexSpan);

        // Add a line break and the Replacement field
        const replacementSpan = document.createElement('div');
        replacementSpan.innerHTML = `<strong>Replacement:</strong> ${rule.replacement}`;
        ruleContent.appendChild(replacementSpan);

        // Create the move up button
        const moveUpButton = document.createElement('button');
        moveUpButton.className = 'btn btn-primary btn-sm me-2';
        moveUpButton.innerHTML = '<i class="bi bi-arrow-up"></i>';
        moveUpButton.onclick = () => moveRuleUp(index);

        // Create the move down button
        const moveDownButton = document.createElement('button');
        moveDownButton.className = 'btn btn-primary btn-sm me-2';
        moveDownButton.innerHTML = '<i class="bi bi-arrow-down"></i>';
        moveDownButton.onclick = () => moveRuleDown(index);

        // Create the delete button (right side)
        const deleteButton = document.createElement('button');
        deleteButton.className = 'btn btn-danger btn-sm';
        deleteButton.textContent = 'Delete';
        deleteButton.onclick = () => deleteRule(index); // Attach delete function

        // Append the content and buttons to the rule item
        const buttonContainer = document.createElement('div');
        buttonContainer.appendChild(moveUpButton);
        buttonContainer.appendChild(moveDownButton);
        buttonContainer.appendChild(deleteButton);

        ruleItem.appendChild(ruleContent);
        ruleItem.appendChild(buttonContainer);

        // Append the rule item to the list
        rulesList.appendChild(ruleItem);
    });
}

// Function to add a new rule
document.getElementById('addRuleForm').addEventListener('submit', function(e) {
    e.preventDefault(); // Prevent form submission

    // Get input values
    const regexInput = document.getElementById('regexInput').value;
    const replacementText = document.getElementById('replacementText').value;
    const ruleName = document.getElementById('ruleName').value;

    // Create a new rule object and add it to the list
    const newRule = { regex: regexInput, replacement: replacementText, name: ruleName };
    rules.push(newRule);

    // Clear the form
    document.getElementById('addRuleForm').reset();
    saveSystems();
    renderRules(); // Ensure the updated list is displayed
});

// Function to delete a rule
function deleteRule(index) {
    rules.splice(index, 1); // Remove the rule from the array
    saveSystems();
    renderRules(); // Ensure the updated list is displayed after deletion
}

// Function to move a rule up
function moveRuleUp(index) {
    if (index > 0) {
        const temp = rules[index];
        rules[index] = rules[index - 1];
        rules[index - 1] = temp;
        saveSystems();
        renderRules();
    }
}

// Function to move a rule down
function moveRuleDown(index) {
    if (index < rules.length - 1) {
        const temp = rules[index];
        rules[index] = rules[index + 1];
        rules[index + 1] = temp;
        saveSystems();
        renderRules();
    }
}

// On page load, load existing rules
window.onload = function() {
    renderRules();
};

</script>
{% endblock %}
