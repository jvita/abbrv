name: Validate Gist Upload

on:
  issues:
    types: [opened]

jobs:
  validate-upload:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.body, 'https://gist.github.com/')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Extract Gist URL from Issue
        run: |
          ISSUE_BODY="${{ github.event.issue.body }}"
          GIST_URL=$(echo "$ISSUE_BODY" | grep -oP 'https://gist.github.com/\S+')

          if [[ -z "$GIST_URL" ]]; then
            echo "❌ No valid Gist URL found in the issue."
            exit 1
          fi

          echo "Extracted Gist URL: $GIST_URL"
          echo "GIST_URL=$GIST_URL" >> $GITHUB_ENV

      - name: Fetch JSON file from Gist
        run: |
          RAW_URL=$(curl -sL "$GIST_URL" | grep -oP 'https://gist.githubusercontent.com/[^"]+raw[^"]+' | head -n 1)

          if [[ -z "$RAW_URL" ]]; then
            echo "❌ Could not find raw JSON file in the Gist."
            exit 1
          fi

          echo "Downloading JSON file from: $RAW_URL"
          curl -L -o json_files/uploaded.json "$RAW_URL"

      - name: Validate JSON File
        run: |
          python3 .github/scripts/validate_json.py json_files/uploaded.json

      - name: Post result to GitHub Issue
        run: |
          ISSUE_NUMBER="${{ github.event.issue.number }}"
          REPO="${{ github.repository }}"
          COMMENT_BODY="✅ JSON validation successful!"
          curl -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -d "{\"body\": \"$COMMENT_BODY\"}" \
            "https://api.github.com/repos/$REPO/issues/$ISSUE_NUMBER/comments"
