name: Validate System Upload Files

on:
  issue_comment:
    types: [created]

jobs:
  validate-files:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request == null
    steps:
      - name: Print raw comment body
        run: |
          echo "Raw comment body:"
          echo "${{ github.event.comment.body }}"

      - name: Check if issue has 'system upload' label
        id: label_check
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(label => label.name);
            console.log("Labels on issue:", labels);
            core.setOutput('has_label', labels.includes('system upload'));

      - name: Exit if label not found
        if: steps.label_check.outputs.has_label != 'true'
        run: |
          echo "No 'system upload' label on issue. Exiting."
          exit 0

      - name: Extract attachment links from comment
        id: extract_urls
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.comment.body;
            const regex = /\[([^\]]+\.json)\]\((https:\/\/github\.com\/user-attachments\/[^\s)]+)\)/g;
            let match;
            const fileMap = {};

            while ((match = regex.exec(body)) !== null) {
              const filename = match[1];
              const url = match[2];
              console.log(`Found file: ${filename} -> ${url}`);
              fileMap[filename] = url;
            }

            const expectedFiles = ['glyphs.json', 'modes.json', 'rules.json', 'phrases.json'];
            for (const name of expectedFiles) {
              if (!fileMap[name]) {
                core.setFailed(`Missing expected file: ${name}`);
              } else {
                core.setOutput(name.replace('.json', ''), fileMap[name]);
              }
            }

      - name: Install Python dependencies
        run: pip install requests

      - name: Download files (follow redirect manually)
        run: |
          echo "Writing redirect-aware fetch script..."
          cat << 'EOF' > fetch_and_save.py
          import os
          import requests

          file_urls = {
              "glyphs.json": os.environ.get("GLYPHS_URL"),
              "modes.json": os.environ.get("MODES_URL"),
              "rules.json": os.environ.get("RULES_URL"),
              "phrases.json": os.environ.get("PHRASES_URL"),
          }

          for filename, initial_url in file_urls.items():
              if not initial_url:
                  print(f"Missing URL for {filename}")
                  continue

              print(f"Resolving redirect for: {initial_url}")
              try:
                  head_resp = requests.get(initial_url, allow_redirects=False)
                  redirect_url = head_resp.headers.get("Location")

                  if not redirect_url:
                      print(f"‚ùå Could not resolve redirect for {filename}")
                      continue

                  print(f"üîÅ Redirected to: {redirect_url}")

                  resp = requests.get(redirect_url)
                  if resp.ok:
                      with open(filename, "wb") as f:
                          f.write(resp.content)
                      print(f"‚úÖ Saved {filename}")
                  else:
                      print(f"‚ùå Failed to download {filename}: {resp.status_code}")
              except Exception as e:
                  print(f"‚ùå Exception downloading {filename}: {e}")
          EOF

          python fetch_and_save.py
        env:
          GLYPHS_URL: ${{ steps.extract_urls.outputs.glyphs }}
          MODES_URL: ${{ steps.extract_urls.outputs.modes }}
          RULES_URL: ${{ steps.extract_urls.outputs.rules }}
          PHRASES_URL: ${{ steps.extract_urls.outputs.phrases }}

      - name: List downloaded files
        run: ls -lh *.json || echo "Some files are missing!"

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Run validation script
        run: python .github/scripts/validate_json.py glyphs.json modes.json rules.json phrases.json
