{% extends "index.html" %}

{% block content %}
<form id="text-form" class="d-flex flex-column justify-content-start">
    <textarea id="text" name="text" placeholder="Enter text here..."></textarea>

    <div id="output"></div>

    <!-- Dropdown Menu -->
    <div class="dropdown mt-3">
        <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
            Options
        </button>
        <!-- <ul class="dropdown-menu multi-column" aria-labelledby="dropdownMenuButton"></ul> -->
        <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
            <li class="dropdown-item button-container align-items-center">
                <input type="checkbox" id="remove_duplicates" name="remove_duplicates" style="max-height: 20px; max-width: 20px; min-width: 20px" checked>
                <label for="remove_duplicates" style="flex: 6;">Remove consecutive duplicates (except "ee")</label>
            </li>
            <li class="dropdown-item button-container align-items-center">
                <input type="checkbox" id="remap_words" name="remap_words" style="max-height: 20px; max-width: 20px; min-width: 20px" checked>
                <label for="remap_words" style="flex: 6;">Abbreviate common words</label>
            </li>
            <li class="dropdown-item button-container align-items-center">
                <input type="checkbox" id="abbreviate_suffixes" name="abbreviate_suffixes" style="max-height: 20px; max-width: 20px; min-width: 20px" checked>
                <label for="abbreviate_suffixes" style="flex: 6;">Abbreviate common suffixes</label>
            </li>
            <li class="dropdown-item button-container align-items-center">
                <input type="checkbox" id="elevate_th" name="elevate_th" style="max-height: 20px; max-width: 20px; min-width: 20px" checked>
                <label for="elevate_th" style="flex: 6;">Elevate "th"</label>
            </li>
            <li class="dropdown-item button-container align-items-center">
                <input type="checkbox" id="show_dots" name="show_dots" style="max-height: 20px; max-width: 20px; min-width: 20px">
                <label for="show_dots" style="flex: 6;">Show dots</label>
            </li>
            <li class="dropdown-item button-container align-items-center">
                <input type="checkbox" id="show_knot_points" name="show_knot_points" style="max-height: 20px; max-width: 20px; min-width: 20px">
                <label for="show_knot_points" style="flex: 6;">Display knot points</label>
            </li>
            <li class="dropdown-item button-container align-items-center">
                <input type="checkbox" id="ao_mn_rule" name="ao_mn_rule" style="max-height: 20px; max-width: 20px; min-width: 20px">
                <label for="ao_mn_rule" style="flex: 6;">Omit "a" and "o" before "m" and "n"</label>
            </li>
            <li class="dropdown-item button-container align-items-center">
                <input type="checkbox" id="acq_rule" name="acq_rule" style="max-height: 20px; max-width: 20px; min-width: 20px">
                <label for="acq_rule" style="flex: 6;">Omit "c" in "acq"</label>
            </li>
            <li class="dropdown-item button-container align-items-center">
                <input type="checkbox" id="adj_rule" name="adj_rule" style="max-height: 20px; max-width: 20px; min-width: 20px">
                <label for="adj_rule" style="flex: 6;">Omit "d" in "adj"</label>
            </li>
            <li class="dropdown-item button-container align-items-center">
                <input type="checkbox" id="tch_rule" name="tch_rule" style="max-height: 20px; max-width: 20px; min-width: 20px">
                <label for="tch_rule" style="flex: 6;">Omit "t" before "ch"</label>
            </li>
            <li class="dropdown-item button-container align-items-center">
                <input type="checkbox" id="ex_rule" name="ex_rule" style="max-height: 20px; max-width: 20px; min-width: 20px">
                <label for="ex_rule" style="flex: 6;">Omit "e" before "x"</label>
            </li>
        </ul>
    </div>

</form>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function() {
        let debounceTimeout;

        function updatePlot() {
            $.ajax({
                type: 'POST',
                url: '/generate_splines',
                data: $('#text-form').serialize(),
                success: function(response) {
                    // Assuming the server returns the raw SVG markup as part of the response
                    $('#output').html(response.image);
                },
                error: function() {
                    $('#output').html('<p>Error generating plot.</p>');
                }
            });
        }

        function debounce(func, delay) {
            return function(...args) {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Debounce the plot update to avoid too many requests
        const debouncedUpdatePlot = debounce(updatePlot, 300);

        // Bind the input event on textarea and change event on checkboxes
        $('#text').on('input', function() {
            debouncedUpdatePlot();
        });

        $('#show_knot_points, #remap_words, #abbreviate_suffixes, #elevate_th, #show_dots, #remove_duplicates, #ao_mn_rule, #acq_rule, #adj_rule, #tch_rule, #ex_rule').on('change', function() {
            updatePlot();  // Call updatePlot immediately when checkboxes are modified
        });

        // Initial plot update
        updatePlot();

        document.getElementById('text').focus();
    });
</script>
{% endblock %}
